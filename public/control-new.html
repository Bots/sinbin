<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SinBin Control Panel</title>
    <link href="./styles/tailwind.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-base-200 min-h-screen">
    <!-- Header -->
    <div class="navbar bg-base-100 shadow-lg">
        <div class="flex-1">
            <div class="flex items-center gap-3">
                <div class="avatar placeholder">
                    <div class="bg-primary text-primary-content rounded-full w-10">
                        <i class="fas fa-trash text-lg"></i>
                    </div>
                </div>
                <div>
                    <h1 class="text-xl font-bold">SinBin Control Panel</h1>
                    <p class="text-sm opacity-70">Real-time profanity monitoring</p>
                </div>
            </div>
        </div>
        <div class="flex-none gap-2">
            <!-- Theme Selector -->
            <div class="dropdown dropdown-end">
                <div tabindex="0" role="button" class="btn btn-ghost btn-circle">
                    <i class="fas fa-palette"></i>
                </div>
                <ul tabindex="0" class="dropdown-content z-[1] menu p-2 shadow bg-base-100 rounded-box w-52">
                    <li><a onclick="setTheme('light')"><i class="fas fa-sun"></i> Light</a></li>
                    <li><a onclick="setTheme('dark')"><i class="fas fa-moon"></i> Dark</a></li>
                    <li><a onclick="setTheme('synthwave')"><i class="fas fa-robot"></i> Synthwave</a></li>
                    <li><a onclick="setTheme('cyberpunk')"><i class="fas fa-desktop"></i> Cyberpunk</a></li>
                </ul>
            </div>

            <!-- Connection Status -->
            <div class="indicator">
                <span class="indicator-item badge badge-success" id="connectionStatus"></span>
                <div class="btn btn-ghost btn-circle">
                    <i class="fas fa-wifi"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="container mx-auto p-4 max-w-7xl">
        <!-- Stats Overview -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
            <div class="stat bg-base-100 rounded-box shadow">
                <div class="stat-figure text-primary">
                    <i class="fas fa-microphone text-2xl"></i>
                </div>
                <div class="stat-title">Mic Penalties</div>
                <div class="stat-value text-primary" id="micCount">0</div>
                <div class="stat-desc">Current session</div>
            </div>

            <div class="stat bg-base-100 rounded-box shadow">
                <div class="stat-figure text-secondary">
                    <i class="fas fa-comments text-2xl"></i>
                </div>
                <div class="stat-title">Chat Penalties</div>
                <div class="stat-value text-secondary" id="chatCount">0</div>
                <div class="stat-desc">All users</div>
            </div>

            <div class="stat bg-base-100 rounded-box shadow">
                <div class="stat-figure text-accent">
                    <i class="fas fa-clock text-2xl"></i>
                </div>
                <div class="stat-title">Clean Streak</div>
                <div class="stat-value text-accent" id="cleanStreak">0</div>
                <div class="stat-desc">minutes</div>
            </div>

            <div class="stat bg-base-100 rounded-box shadow">
                <div class="stat-figure text-info">
                    <i class="fas fa-chart-line text-2xl"></i>
                </div>
                <div class="stat-title">Total Count</div>
                <div class="stat-value text-info" id="totalCount">0</div>
                <div class="stat-desc">All time</div>
            </div>
        </div>

        <!-- Main Content Tabs -->
        <div class="tabs tabs-bordered mb-4">
            <a class="tab tab-active" onclick="showTab('dashboard')">
                <i class="fas fa-tachometer-alt mr-2"></i>Dashboard
            </a>
            <a class="tab" onclick="showTab('speech')">
                <i class="fas fa-microphone mr-2"></i>Speech
            </a>
            <a class="tab" onclick="showTab('chat')">
                <i class="fas fa-comments mr-2"></i>Chat
            </a>
            <a class="tab" onclick="showTab('sounds')">
                <i class="fas fa-volume-up mr-2"></i>Sounds
            </a>
            <a class="tab" onclick="showTab('overlay')">
                <i class="fas fa-display mr-2"></i>Overlay
            </a>
            <a class="tab" onclick="showTab('settings')">
                <i class="fas fa-cog mr-2"></i>Settings
            </a>
        </div>

        <!-- Tab Content -->
        <div class="tab-content">
            <!-- Dashboard Tab -->
            <div id="dashboard-tab" class="tab-pane active">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Quick Actions -->
                    <div class="card bg-base-100 shadow-xl">
                        <div class="card-body">
                            <h2 class="card-title">
                                <i class="fas fa-bolt text-warning"></i>
                                Quick Actions
                            </h2>

                            <div class="grid grid-cols-2 gap-4">
                                <button class="btn btn-primary" onclick="startListening()">
                                    <i class="fas fa-play mr-2"></i>Start Listening
                                </button>
                                <button class="btn btn-warning" onclick="stopListening()">
                                    <i class="fas fa-stop mr-2"></i>Stop Listening
                                </button>
                                <button class="btn btn-error" onclick="resetCounter()">
                                    <i class="fas fa-redo mr-2"></i>Reset Counter
                                </button>
                                <button class="btn btn-success" onclick="testSound()">
                                    <i class="fas fa-music mr-2"></i>Test Sound
                                </button>
                            </div>

                            <div class="divider">Current Status</div>

                            <div class="flex justify-between items-center">
                                <span>Speech Recognition:</span>
                                <div class="badge badge-primary" id="speechStatus">Stopped</div>
                            </div>
                            <div class="flex justify-between items-center">
                                <span>Chat Monitoring:</span>
                                <div class="badge badge-secondary" id="chatStatus">Disconnected</div>
                            </div>
                            <div class="flex justify-between items-center">
                                <span>Auto-Reset:</span>
                                <div class="badge badge-accent" id="autoResetStatus">Disabled</div>
                            </div>
                        </div>
                    </div>

                    <!-- Session Stats -->
                    <div class="card bg-base-100 shadow-xl">
                        <div class="card-body">
                            <h2 class="card-title">
                                <i class="fas fa-chart-bar text-info"></i>
                                Session Analytics
                            </h2>

                            <div class="stats stats-vertical shadow">
                                <div class="stat">
                                    <div class="stat-title">Session Duration</div>
                                    <div class="stat-value text-primary" id="sessionDuration">00:00:00</div>
                                </div>

                                <div class="stat">
                                    <div class="stat-title">Penalties per Hour</div>
                                    <div class="stat-value text-secondary" id="penaltiesPerHour">0</div>
                                </div>

                                <div class="stat">
                                    <div class="stat-title">Worst Word</div>
                                    <div class="stat-value text-sm" id="worstWord">None</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Top Chat Users -->
                    <div class="card bg-base-100 shadow-xl">
                        <div class="card-body">
                            <h2 class="card-title">
                                <i class="fas fa-users text-error"></i>
                                Top Offenders
                            </h2>

                            <div class="overflow-x-auto">
                                <table class="table table-xs">
                                    <thead>
                                        <tr>
                                            <th>Rank</th>
                                            <th>Username</th>
                                            <th>Penalties</th>
                                            <th>Messages</th>
                                        </tr>
                                    </thead>
                                    <tbody id="topUsersTable">
                                        <tr>
                                            <td colspan="4" class="text-center text-gray-500">No data available</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Activity -->
                    <div class="card bg-base-100 shadow-xl">
                        <div class="card-body">
                            <h2 class="card-title">
                                <i class="fas fa-history text-warning"></i>
                                Recent Activity
                            </h2>

                            <div class="space-y-2 max-h-64 overflow-y-auto" id="recentActivity">
                                <div class="text-center text-gray-500 py-8">No recent activity</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Speech Tab -->
            <div id="speech-tab" class="tab-pane hidden">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Speech Settings -->
                    <div class="card bg-base-100 shadow-xl">
                        <div class="card-body">
                            <h2 class="card-title">
                                <i class="fas fa-microphone text-primary"></i>
                                Speech Recognition
                            </h2>

                            <div class="form-control">
                                <label class="label cursor-pointer">
                                    <span class="label-text">Enable Speech Recognition</span>
                                    <input type="checkbox" class="toggle toggle-primary" checked id="speechEnabled">
                                </label>
                            </div>

                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text">Confidence Threshold</span>
                                </label>
                                <input type="range" min="0" max="1" step="0.1" value="0.3" class="range range-primary" id="confidenceThreshold">
                                <div class="w-full flex justify-between text-xs px-2">
                                    <span>Low</span>
                                    <span>Medium</span>
                                    <span>High</span>
                                </div>
                            </div>

                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text">Current Transcript</span>
                                </label>
                                <div class="textarea textarea-bordered min-h-20 bg-base-200" id="liveTranscript">
                                    Waiting for speech...
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Word Management -->
                    <div class="card bg-base-100 shadow-xl">
                        <div class="card-body">
                            <h2 class="card-title">
                                <i class="fas fa-list text-warning"></i>
                                Word Management
                            </h2>

                            <div class="join w-full mb-4">
                                <input class="input input-bordered join-item flex-1" placeholder="Add custom word..." id="newWordInput">
                                <button class="btn btn-primary join-item" onclick="addCustomWord()">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>

                            <div class="tabs tabs-boxed mb-4">
                                <a class="tab tab-active" onclick="showWordList('custom')">Custom</a>
                                <a class="tab" onclick="showWordList('predefined')">Predefined</a>
                            </div>

                            <div class="max-h-64 overflow-y-auto">
                                <div id="customWords" class="space-y-2">
                                    <!-- Custom words will be loaded here -->
                                </div>
                                <div id="predefinedWords" class="space-y-2 hidden">
                                    <!-- Predefined words will be loaded here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Chat Tab -->
            <div id="chat-tab" class="tab-pane hidden">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Chat Connection -->
                    <div class="card bg-base-100 shadow-xl">
                        <div class="card-body">
                            <h2 class="card-title">
                                <i class="fas fa-twitch text-purple-500"></i>
                                Twitch Connection
                            </h2>

                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text">Channel Name</span>
                                </label>
                                <input type="text" placeholder="your-channel-name" class="input input-bordered" id="chatChannel">
                            </div>

                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text">Bot Username (Optional)</span>
                                </label>
                                <input type="text" placeholder="your-bot-username" class="input input-bordered" id="chatUsername">
                            </div>

                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text">OAuth Token (Optional)</span>
                                </label>
                                <input type="password" placeholder="oauth:your-token" class="input input-bordered" id="chatOAuth">
                            </div>

                            <div class="card-actions justify-end">
                                <button class="btn btn-success" onclick="connectChat()">
                                    <i class="fas fa-plug mr-2"></i>Connect
                                </button>
                                <button class="btn btn-error" onclick="disconnectChat()">
                                    <i class="fas fa-unlink mr-2"></i>Disconnect
                                </button>
                            </div>

                            <div class="alert alert-info">
                                <i class="fas fa-info-circle"></i>
                                <span>Chat monitoring will track penalties from viewers. OAuth token is only needed for bot features.</span>
                            </div>
                        </div>
                    </div>

                    <!-- Chat Stats -->
                    <div class="card bg-base-100 shadow-xl">
                        <div class="card-body">
                            <h2 class="card-title">
                                <i class="fas fa-chart-pie text-info"></i>
                                Chat Statistics
                            </h2>

                            <div class="stats stats-vertical shadow">
                                <div class="stat">
                                    <div class="stat-title">Active Users</div>
                                    <div class="stat-value" id="activeUsers">0</div>
                                </div>
                                <div class="stat">
                                    <div class="stat-title">Total Messages</div>
                                    <div class="stat-value" id="totalMessages">0</div>
                                </div>
                                <div class="stat">
                                    <div class="stat-title">Chat Penalties</div>
                                    <div class="stat-value text-error" id="chatPenalties">0</div>
                                </div>
                            </div>

                            <div class="form-control mt-4">
                                <label class="label cursor-pointer">
                                    <span class="label-text">Separate Chat Counter</span>
                                    <input type="checkbox" class="toggle toggle-secondary" id="separateChatCounter">
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sounds Tab -->
            <div id="sounds-tab" class="tab-pane hidden">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Sound Upload -->
                    <div class="card bg-base-100 shadow-xl">
                        <div class="card-body">
                            <h2 class="card-title">
                                <i class="fas fa-upload text-success"></i>
                                Upload Custom Sounds
                            </h2>

                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text">Sound Category</span>
                                </label>
                                <select class="select select-bordered" id="soundCategory">
                                    <option value="penalty">Penalty Sound</option>
                                    <option value="threshold">Threshold Alert</option>
                                    <option value="goal">Goal Achievement</option>
                                    <option value="system">System Sound</option>
                                </select>
                            </div>

                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text">Description</span>
                                </label>
                                <input type="text" placeholder="Sound description..." class="input input-bordered" id="soundDescription">
                            </div>

                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text">Audio File (MP3, WAV, OGG - Max 5MB)</span>
                                </label>
                                <input type="file" class="file-input file-input-bordered" accept="audio/*" id="soundFile">
                            </div>

                            <div class="card-actions justify-end">
                                <button class="btn btn-primary" onclick="uploadSound()">
                                    <i class="fas fa-upload mr-2"></i>Upload Sound
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Sound Library -->
                    <div class="card bg-base-100 shadow-xl">
                        <div class="card-body">
                            <h2 class="card-title">
                                <i class="fas fa-music text-primary"></i>
                                Sound Library
                            </h2>

                            <div class="form-control mb-4">
                                <label class="label">
                                    <span class="label-text">Master Volume</span>
                                </label>
                                <input type="range" min="0" max="1" step="0.1" value="0.5" class="range range-primary" id="masterVolume">
                                <div class="w-full flex justify-between text-xs px-2">
                                    <span>0%</span>
                                    <span>50%</span>
                                    <span>100%</span>
                                </div>
                            </div>

                            <div class="max-h-64 overflow-y-auto space-y-2" id="soundLibrary">
                                <div class="text-center text-gray-500 py-8">No custom sounds uploaded</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Overlay Tab -->
            <div id="overlay-tab" class="tab-pane hidden">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Overlay Settings -->
                    <div class="card bg-base-100 shadow-xl">
                        <div class="card-body">
                            <h2 class="card-title">
                                <i class="fas fa-display text-info"></i>
                                Overlay Configuration
                            </h2>

                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text">Layout</span>
                                </label>
                                <select class="select select-bordered" id="overlayLayout">
                                    <option value="vertical">Vertical Stack</option>
                                    <option value="horizontal">Horizontal Row</option>
                                </select>
                            </div>

                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text">Transcript Position</span>
                                </label>
                                <select class="select select-bordered" id="transcriptPosition">
                                    <option value="below">Below Bin</option>
                                    <option value="above">Above Bin</option>
                                </select>
                            </div>

                            <div class="form-control">
                                <label class="label cursor-pointer">
                                    <span class="label-text">Show Background</span>
                                    <input type="checkbox" class="toggle toggle-primary" checked id="showBackground">
                                </label>
                            </div>

                            <div class="form-control">
                                <label class="label cursor-pointer">
                                    <span class="label-text">Show Transcript</span>
                                    <input type="checkbox" class="toggle toggle-primary" checked id="showTranscript">
                                </label>
                            </div>

                            <div class="card-actions justify-end">
                                <button class="btn btn-primary" onclick="saveOverlaySettings()">
                                    <i class="fas fa-save mr-2"></i>Save Settings
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Threshold Configuration -->
                    <div class="card bg-base-100 shadow-xl">
                        <div class="card-body">
                            <h2 class="card-title">
                                <i class="fas fa-exclamation-triangle text-warning"></i>
                                Penalty Thresholds
                            </h2>

                            <div class="space-y-4">
                                <div class="form-control">
                                    <label class="label">
                                        <span class="label-text">Warning Level</span>
                                    </label>
                                    <div class="flex gap-2">
                                        <input type="number" value="5" class="input input-bordered flex-1" id="warningThreshold">
                                        <input type="color" value="#f59e0b" class="w-12 h-12 rounded" id="warningColor">
                                    </div>
                                </div>

                                <div class="form-control">
                                    <label class="label">
                                        <span class="label-text">Danger Level</span>
                                    </label>
                                    <div class="flex gap-2">
                                        <input type="number" value="10" class="input input-bordered flex-1" id="dangerThreshold">
                                        <input type="color" value="#ef4444" class="w-12 h-12 rounded" id="dangerColor">
                                    </div>
                                </div>
                            </div>

                            <div class="card-actions justify-end">
                                <button class="btn btn-warning" onclick="saveThresholds()">
                                    <i class="fas fa-save mr-2"></i>Save Thresholds
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Preview -->
                    <div class="card bg-base-100 shadow-xl col-span-1 lg:col-span-2">
                        <div class="card-body">
                            <h2 class="card-title">
                                <i class="fas fa-eye text-accent"></i>
                                Overlay Preview
                            </h2>

                            <div class="bg-base-200 rounded-lg p-4 min-h-32 flex items-center justify-center">
                                <div class="text-center">
                                    <div class="text-4xl mb-2">🗑️</div>
                                    <div class="text-2xl font-bold" id="previewCounter">0</div>
                                    <div class="text-sm opacity-70 mt-2">Live Transcript Preview</div>
                                </div>
                            </div>

                            <div class="text-center mt-4">
                                <code class="bg-base-300 px-2 py-1 rounded">
                                    Overlay URL: http://localhost:3000/overlay.html
                                </code>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="settings-tab" class="tab-pane hidden">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Auto-Reset Settings -->
                    <div class="card bg-base-100 shadow-xl">
                        <div class="card-body">
                            <h2 class="card-title">
                                <i class="fas fa-clock text-accent"></i>
                                Auto-Reset
                            </h2>

                            <div class="form-control">
                                <label class="label cursor-pointer">
                                    <span class="label-text">Enable Auto-Reset</span>
                                    <input type="checkbox" class="toggle toggle-accent" id="autoResetEnabled">
                                </label>
                            </div>

                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text">Reset after clean speech (minutes)</span>
                                </label>
                                <input type="number" min="1" max="120" value="30" class="input input-bordered" id="autoResetDuration">
                            </div>

                            <div class="card-actions justify-end">
                                <button class="btn btn-accent" onclick="saveAutoResetSettings()">
                                    <i class="fas fa-save mr-2"></i>Save Settings
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Data Management -->
                    <div class="card bg-base-100 shadow-xl">
                        <div class="card-body">
                            <h2 class="card-title">
                                <i class="fas fa-database text-error"></i>
                                Data Management
                            </h2>

                            <div class="space-y-4">
                                <button class="btn btn-warning w-full" onclick="resetSession()">
                                    <i class="fas fa-redo mr-2"></i>Reset Current Session
                                </button>

                                <button class="btn btn-info w-full" onclick="exportData()">
                                    <i class="fas fa-download mr-2"></i>Export Session Data
                                </button>

                                <button class="btn btn-error w-full" onclick="resetAllData()">
                                    <i class="fas fa-trash mr-2"></i>Reset All Data
                                </button>
                            </div>

                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle"></i>
                                <span>Data operations cannot be undone!</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // Modern SinBin Control Panel
        class ModernSinBinControl {
            constructor() {
                this.socket = io()
                this.currentTab = 'dashboard'
                this.setupSocketEvents()
                this.initializeUI()
                this.loadInitialData()
            }

            setupSocketEvents() {
                this.socket.on('connect', () => {
                    this.updateConnectionStatus(true)
                })

                this.socket.on('disconnect', () => {
                    this.updateConnectionStatus(false)
                })

                this.socket.on('countUpdate', (count) => {
                    this.updateCounts({ total: count })
                })

                this.socket.on('transcriptUpdate', (text) => {
                    this.updateLiveTranscript(text)
                })

                this.socket.on('penaltyDetected', (penalty) => {
                    this.addRecentActivity(penalty)
                })

                this.socket.on('statusUpdate', (status) => {
                    this.updateSpeechStatus(status)
                })
            }

            initializeUI() {
                // Set initial theme
                const savedTheme = localStorage.getItem('sinbin-theme') || 'light'
                this.setTheme(savedTheme)

                // Initialize tab system
                this.showTab('dashboard')

                // Load saved settings
                this.loadSavedSettings()
            }

            async loadInitialData() {
                try {
                    const [stats, words, sounds] = await Promise.all([
                        fetch('/api/stats').then(r => r.json()),
                        fetch('/api/words').then(r => r.json()),
                        fetch('/api/sounds').then(r => r.json())
                    ])

                    this.updateStats(stats)
                    this.updateWordLists(words)
                    this.updateSoundLibrary(sounds)
                } catch (error) {
                    console.error('Error loading initial data:', error)
                }
            }

            updateConnectionStatus(connected) {
                const status = document.getElementById('connectionStatus')
                if (connected) {
                    status.className = 'indicator-item badge badge-success'
                    status.textContent = ''
                } else {
                    status.className = 'indicator-item badge badge-error'
                    status.textContent = ''
                }
            }

            updateCounts(counts) {
                document.getElementById('totalCount').textContent = counts.total || 0
                document.getElementById('micCount').textContent = counts.mic || 0
                document.getElementById('chatCount').textContent = counts.chat || 0
                document.getElementById('previewCounter').textContent = counts.total || 0
            }

            updateLiveTranscript(text) {
                document.getElementById('liveTranscript').textContent = text || 'Waiting for speech...'
            }

            updateSpeechStatus(status) {
                const statusEl = document.getElementById('speechStatus')
                statusEl.textContent = status === 'listening' ? 'Listening' : 'Stopped'
                statusEl.className = status === 'listening' ? 'badge badge-success' : 'badge badge-error'
            }

            addRecentActivity(penalty) {
                const container = document.getElementById('recentActivity')
                const activity = document.createElement('div')
                activity.className = 'alert alert-warning'
                activity.innerHTML = `
                    <i class="fas fa-exclamation-triangle"></i>
                    <div>
                        <div class="font-bold">${penalty.source === 'mic' ? 'Microphone' : 'Chat'} Penalty</div>
                        <div class="text-xs">${penalty.word} - ${new Date().toLocaleTimeString()}</div>
                    </div>
                `
                container.insertBefore(activity, container.firstChild)

                // Keep only last 10 activities
                while (container.children.length > 10) {
                    container.removeChild(container.lastChild)
                }
            }

            showTab(tabName) {
                // Update tab buttons
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.classList.remove('tab-active')
                })
                event?.target.classList.add('tab-active')

                // Show/hide tab content
                document.querySelectorAll('.tab-pane').forEach(pane => {
                    pane.classList.add('hidden')
                })
                document.getElementById(`${tabName}-tab`).classList.remove('hidden')

                this.currentTab = tabName
            }

            setTheme(theme) {
                document.documentElement.setAttribute('data-theme', theme)
                localStorage.setItem('sinbin-theme', theme)
            }

            // API Methods
            async startListening() {
                this.socket.emit('startListening')
            }

            async stopListening() {
                this.socket.emit('stopListening')
            }

            async resetCounter() {
                if (confirm('Are you sure you want to reset the penalty counter?')) {
                    try {
                        await fetch('/api/reset', { method: 'POST' })
                    } catch (error) {
                        console.error('Error resetting counter:', error)
                    }
                }
            }

            async testSound() {
                try {
                    await fetch('/api/test-sound', { method: 'POST' })
                } catch (error) {
                    console.error('Error testing sound:', error)
                }
            }

            // Word Management
            async addCustomWord() {
                const input = document.getElementById('newWordInput')
                const word = input.value.trim().toLowerCase()
                if (!word) return

                try {
                    const response = await fetch('/api/words', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ word })
                    })
                    if (response.ok) {
                        input.value = ''
                        await this.loadCustomWords()
                    }
                } catch (error) {
                    console.error('Error adding custom word:', error)
                }
            }

            async removeCustomWord(word) {
                try {
                    await fetch(`/api/words/${encodeURIComponent(word)}`, { method: 'DELETE' })
                    await this.loadCustomWords()
                } catch (error) {
                    console.error('Error removing custom word:', error)
                }
            }

            async loadCustomWords() {
                try {
                    const response = await fetch('/api/words')
                    const words = await response.json()
                    this.updateWordLists(words)
                } catch (error) {
                    console.error('Error loading words:', error)
                }
            }

            updateWordLists(words) {
                const customContainer = document.getElementById('customWords')
                const predefinedContainer = document.getElementById('predefinedWords')

                // Update custom words
                customContainer.innerHTML = words.custom?.map(word => `
                    <div class="flex justify-between items-center p-2 bg-base-200 rounded">
                        <span>${word}</span>
                        <button class="btn btn-error btn-xs" onclick="controlPanel.removeCustomWord('${word}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `).join('') || '<div class="text-center text-gray-500 py-4">No custom words added</div>'

                // Update predefined words
                predefinedContainer.innerHTML = words.predefined?.map(word => `
                    <div class="p-2 bg-base-200 rounded">
                        <span>${word}</span>
                    </div>
                `).join('') || '<div class="text-center text-gray-500 py-4">No predefined words</div>'
            }

            showWordList(type) {
                document.querySelectorAll('#customWords, #predefinedWords').forEach(el => {
                    el.classList.add('hidden')
                })
                document.getElementById(`${type}Words`).classList.remove('hidden')

                // Update tab buttons
                document.querySelectorAll('.tabs-boxed .tab').forEach(tab => {
                    tab.classList.remove('tab-active')
                })
                event.target.classList.add('tab-active')
            }

            // Chat Management
            async connectChat() {
                const channel = document.getElementById('chatChannel').value.trim()
                const username = document.getElementById('chatUsername').value.trim()
                const oauth = document.getElementById('chatOAuth').value.trim()

                if (!channel) {
                    alert('Channel name is required')
                    return
                }

                try {
                    const response = await fetch('/api/chat/connect', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ channel, username, oauth })
                    })
                    if (response.ok) {
                        document.getElementById('chatStatus').textContent = 'Connected'
                        document.getElementById('chatStatus').className = 'badge badge-success'
                    }
                } catch (error) {
                    console.error('Error connecting to chat:', error)
                }
            }

            async disconnectChat() {
                try {
                    await fetch('/api/chat/disconnect', { method: 'POST' })
                    document.getElementById('chatStatus').textContent = 'Disconnected'
                    document.getElementById('chatStatus').className = 'badge badge-error'
                } catch (error) {
                    console.error('Error disconnecting from chat:', error)
                }
            }

            // Sound Management
            async uploadSound() {
                const fileInput = document.getElementById('soundFile')
                const category = document.getElementById('soundCategory').value
                const description = document.getElementById('soundDescription').value.trim()

                if (!fileInput.files[0]) {
                    alert('Please select an audio file')
                    return
                }

                if (!description) {
                    alert('Please provide a description')
                    return
                }

                const formData = new FormData()
                formData.append('audio', fileInput.files[0])
                formData.append('category', category)
                formData.append('description', description)

                try {
                    const response = await fetch('/api/sounds/upload', {
                        method: 'POST',
                        body: formData
                    })
                    if (response.ok) {
                        fileInput.value = ''
                        document.getElementById('soundDescription').value = ''
                        await this.loadSounds()
                    }
                } catch (error) {
                    console.error('Error uploading sound:', error)
                }
            }

            async loadSounds() {
                try {
                    const response = await fetch('/api/sounds')
                    const sounds = await response.json()
                    this.updateSoundLibrary(sounds)
                } catch (error) {
                    console.error('Error loading sounds:', error)
                }
            }

            updateSoundLibrary(sounds) {
                const container = document.getElementById('soundLibrary')
                if (!sounds || sounds.length === 0) {
                    container.innerHTML = '<div class="text-center text-gray-500 py-8">No custom sounds uploaded</div>'
                    return
                }

                container.innerHTML = sounds.map(sound => `
                    <div class="card card-compact bg-base-200">
                        <div class="card-body">
                            <div class="flex justify-between items-center">
                                <div>
                                    <h3 class="font-bold">${sound.description || sound.filename}</h3>
                                    <p class="text-xs opacity-70">${sound.category}</p>
                                </div>
                                <div class="flex gap-2">
                                    <button class="btn btn-primary btn-xs" onclick="controlPanel.playSound('${sound.filename}')">
                                        <i class="fas fa-play"></i>
                                    </button>
                                    <button class="btn btn-error btn-xs" onclick="controlPanel.deleteSound('${sound.filename}')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('')
            }

            async playSound(filename) {
                try {
                    await fetch(`/api/sounds/play/${encodeURIComponent(filename)}`, { method: 'POST' })
                } catch (error) {
                    console.error('Error playing sound:', error)
                }
            }

            async deleteSound(filename) {
                if (confirm('Are you sure you want to delete this sound?')) {
                    try {
                        await fetch(`/api/sounds/${encodeURIComponent(filename)}`, { method: 'DELETE' })
                        await this.loadSounds()
                    } catch (error) {
                        console.error('Error deleting sound:', error)
                    }
                }
            }

            // Settings Management
            async saveOverlaySettings() {
                const settings = {
                    layout: document.getElementById('overlayLayout').value,
                    transcriptPosition: document.getElementById('transcriptPosition').value,
                    showBackground: document.getElementById('showBackground').checked,
                    showTranscript: document.getElementById('showTranscript').checked
                }

                try {
                    await fetch('/api/settings', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(settings)
                    })
                    alert('Overlay settings saved!')
                } catch (error) {
                    console.error('Error saving overlay settings:', error)
                }
            }

            async saveThresholds() {
                const thresholds = {
                    warning: {
                        count: parseInt(document.getElementById('warningThreshold').value),
                        color: document.getElementById('warningColor').value
                    },
                    danger: {
                        count: parseInt(document.getElementById('dangerThreshold').value),
                        color: document.getElementById('dangerColor').value
                    }
                }

                try {
                    await fetch('/api/thresholds', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(thresholds)
                    })
                    alert('Thresholds saved!')
                } catch (error) {
                    console.error('Error saving thresholds:', error)
                }
            }

            async saveAutoResetSettings() {
                const settings = {
                    enabled: document.getElementById('autoResetEnabled').checked,
                    duration: parseInt(document.getElementById('autoResetDuration').value)
                }

                try {
                    await fetch('/api/auto-reset', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(settings)
                    })
                    alert('Auto-reset settings saved!')
                } catch (error) {
                    console.error('Error saving auto-reset settings:', error)
                }
            }

            // Data Management
            async resetSession() {
                if (confirm('Are you sure you want to reset the current session? This will clear all session data.')) {
                    try {
                        await fetch('/api/reset-session', { method: 'POST' })
                        location.reload()
                    } catch (error) {
                        console.error('Error resetting session:', error)
                    }
                }
            }

            async exportData() {
                try {
                    const response = await fetch('/api/export')
                    const data = await response.json()

                    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' })
                    const url = URL.createObjectURL(blob)
                    const a = document.createElement('a')
                    a.href = url
                    a.download = `sinbin-session-${new Date().toISOString().split('T')[0]}.json`
                    a.click()
                    URL.revokeObjectURL(url)
                } catch (error) {
                    console.error('Error exporting data:', error)
                }
            }

            async resetAllData() {
                if (confirm('Are you sure you want to reset ALL data? This cannot be undone!')) {
                    if (confirm('This will delete all sessions, penalties, and user data. Are you absolutely sure?')) {
                        try {
                            await fetch('/api/reset-all', { method: 'POST' })
                            location.reload()
                        } catch (error) {
                            console.error('Error resetting all data:', error)
                        }
                    }
                }
            }

            // Load and update stats
            async updateStats(stats) {
                if (stats) {
                    this.updateCounts(stats.counts || {})
                    document.getElementById('cleanStreak').textContent = Math.floor((stats.cleanStreak || 0) / 60000)
                    document.getElementById('sessionDuration').textContent = this.formatDuration(stats.sessionDuration || 0)
                    document.getElementById('penaltiesPerHour').textContent = stats.penaltiesPerHour || 0
                    document.getElementById('worstWord').textContent = stats.worstWord || 'None'

                    // Update chat stats
                    document.getElementById('activeUsers').textContent = stats.chat?.activeUsers || 0
                    document.getElementById('totalMessages').textContent = stats.chat?.totalMessages || 0
                    document.getElementById('chatPenalties').textContent = stats.chat?.penalties || 0

                    // Update top users table
                    this.updateTopUsersTable(stats.chat?.topUsers || [])
                }
            }

            updateTopUsersTable(users) {
                const tbody = document.getElementById('topUsersTable')
                if (users.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="text-center text-gray-500">No data available</td></tr>'
                    return
                }

                tbody.innerHTML = users.map((user, index) => `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${user.username}</td>
                        <td>${user.penalties}</td>
                        <td>${user.messages}</td>
                    </tr>
                `).join('')
            }

            formatDuration(ms) {
                const hours = Math.floor(ms / 3600000)
                const minutes = Math.floor((ms % 3600000) / 60000)
                const seconds = Math.floor((ms % 60000) / 1000)
                return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`
            }

            loadSavedSettings() {
                // Load any saved settings from localStorage or server
                const savedLayout = localStorage.getItem('sinbin-layout')
                if (savedLayout) {
                    document.getElementById('overlayLayout').value = savedLayout
                }
            }
        }

        // Global functions for DaisyUI components
        let controlPanel

        function showTab(tabName) {
            controlPanel.showTab(tabName)
        }

        function setTheme(theme) {
            controlPanel.setTheme(theme)
        }

        function startListening() {
            controlPanel.startListening()
        }

        function stopListening() {
            controlPanel.stopListening()
        }

        function resetCounter() {
            controlPanel.resetCounter()
        }

        function testSound() {
            controlPanel.testSound()
        }

        function addCustomWord() {
            controlPanel.addCustomWord()
        }

        function showWordList(type) {
            controlPanel.showWordList(type)
        }

        function connectChat() {
            controlPanel.connectChat()
        }

        function disconnectChat() {
            controlPanel.disconnectChat()
        }

        function uploadSound() {
            controlPanel.uploadSound()
        }

        function saveOverlaySettings() {
            controlPanel.saveOverlaySettings()
        }

        function saveThresholds() {
            controlPanel.saveThresholds()
        }

        function saveAutoResetSettings() {
            controlPanel.saveAutoResetSettings()
        }

        function resetSession() {
            controlPanel.resetSession()
        }

        function exportData() {
            controlPanel.exportData()
        }

        function resetAllData() {
            controlPanel.resetAllData()
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            controlPanel = new ModernSinBinControl()
        })
    </script>
</body>
</html>